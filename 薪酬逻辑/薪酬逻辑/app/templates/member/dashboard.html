<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <title>团员主页</title>
</head>
<body>

    <div class="container mt-5">
        <div class="card shadow-lg p-4">
            <h2 class="text-center mb-4">个人薪酬数据查看</h2>
            <form method="POST" class="d-flex flex-wrap justify-content-center gap-3 mb-4">
                <div>
                    <label class="form-label">选择数据视图：</label>
                    <select class="form-select" name="department" required>
                        <option value="文案部" {% if dept=='文案部' %}selected{% endif %}>文案部</option>
                        <option value="编辑部" {% if dept=='编辑部' %}selected{% endif %}>编辑部</option>
                        <option value="影视部" {% if dept=='影视部' %}selected{% endif %}>影视部</option>
                        <option value="其他" {% if dept=='其他' %}selected{% endif %}>其他</option>
                        <option value="总计表格" {% if dept=='总计表格' %}selected{% endif %}>总计表格</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">选择月份：</label>
                    <select class="form-select" id="month" name="month" required>
                        {% for m in months %}
                        <option value="{{ m }}" {% if m==month %}selected{% endif %}>{{ m }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="align-self-end">
                    <button type="submit" class="btn-outline-black" name="action" id="action" value="query">查询</button>
                </div>
            </form>

            {% if records %}
            <form id="dataForm">
                <input type="hidden" name="department" value="{{ dept }}">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle " id="dataTable">
                        <thead class="table-light">
                            <tr>
                                {% if dept!='总计表格' %}
                                <th class="col_删除">删除</th>{% endif %}
                                {% for col in columns %}
                                <th class="col_{{col}}">{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in records %}
                            <tr>
                                {% if dept!='总计表格' %}
                                <td>
                                    <button type="button" class="btn-outline-black" title="删除" onclick="deleteRow(this)">×</button>
                                </td>
                                {% endif %}
                                {% for item, col in row|zip(columns) %}
                                <td>
                                    {% if col == '总和' %}
                                    <input type="text" class="form-control " name="{{ col }}" value="{{ item }}">
                                    {% elif col in ['是否采用', '是否原创', '是否广受好评1', '是否广受好评2', '工作类型'] %}
                                    <select class="form-select " name="{{ col }}">
                                        {% if col == '工作类型' %}
                                        <option value="拍摄" {% if item=='拍摄' %}selected{% endif %}>拍摄</option>
                                        <option value="视频相关" {% if item=='视频相关' %}selected{% endif %}>视频相关</option>
                                        {% else %}
                                        <option value="是" {% if item=='是' %}selected{% endif %}>是</option>
                                        <option value="否" {% if item=='否' %}selected{% endif %}>否</option>
                                        {% endif %}
                                    </select>
                                    {% elif col in ['有哪些工作由记者团完成', '你负责了哪些工作'] %}
                                    <input type="text" class="form-control " name="{{ col }}" value="{{ item }}" onclick="openMultiSelect(this)">
                                    {% else %}
                                    <input type="text" class="form-control " name="{{ col }}" value="{{ item }}">
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="d-flex gap-3 mt-3">
                    <button type="button" class="btn-outline-black" onclick="addRow()">添加行</button>
                    <button type="button" class="btn-outline-black" onclick="collectDataAndSubmit()">保存</button>
                    <span class="text-muted align-self-center">(耐心等待，切勿重复点击)</span>
                </div>
            </form>
            {% else %}
            <h4 class="text-center">没有查询到数据</h4>
            <div class="d-flex justify-content-center gap-3 mt-3">
                <button type="button" class="btn-outline-black" onclick="addRow()">添加行</button>
                <span class="text-muted align-self-center">(耐心等待，切勿重复点击)</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 多选弹窗 -->
    <div class="modal fade" id="multiSelectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width:600px">
            <div class="modal-content rounded-3 shadow">
                <div class="modal-header border-0 bg-light rounded-top">
                    <h5 class="modal-title fw-bold ">请选择内容</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="multiSelectOptions" class="d-flex flex-wrap gap-2"></div>
                </div>
                <div class="modal-footer border-0 bg-light rounded-bottom d-flex justify-content-end">
                    <button type="button" class="btn-outline-black" id="multiSelectConfirm">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加行数弹窗 -->
    <div class="modal fade" id="textModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-3 shadow">
                <div class="modal-header border-0 bg-light rounded-top">
                    <h5 class="modal-title fw-bold">添加行数</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body p-4">
                    <label class="form-label mb-2">请输入要添加的行数（小写数字）</label>
                    <input type="number" min="1" id="textModalInput" name="textModalInput" class="form-control" placeholder="例如：3">
                </div>
                <div class="modal-footer border-0 bg-light rounded-bottom d-flex justify-content-between">
                    <button type="button" class="btn-outline-black" data-bs-dismiss="modal" id="textconcel">取消</button>
                    <button type="button" class="btn-outline-black" id="textConfirm">确定</button>
                </div>
            </div>
        </div>
    </div>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
// ======================= 全局配置 =======================
const dept = "{{ dept }}";
const multiSelectOptionsMap = {
    "有哪些工作由记者团完成": ["策划人、负责人","脚本","剪辑","配音","拍摄","灯光、场务、妆造、模特"],
    "你负责了哪些工作": ["策划人、负责人","脚本","剪辑","配音","拍摄","灯光、场务、妆造、模特"]
};

let currentMultiSelectInput = null;

function initDisableLogic() {
    const rows = document.querySelectorAll('table tbody tr');

    rows.forEach(row => {
        const getField = (name) => row.querySelector(`[name$="${name}"]`);

        const fields = {
            '是否采用': getField('是否采用'),
            '是否原创': getField('是否原创'),
            '工作类型': getField('工作类型')
        };

        function updateDisabled() {  //空值处理
            const val = (f) => f ? f.value : '';
            const isAdopted = val(fields['是否采用']);
            const isOriginal = val(fields['是否原创']);
            const workType = val(fields['工作类型']);

            function disable(names, condition) {
                names.forEach((n) => {
                    const el = getField(n);
                    if (el) el.disabled = condition;
                });
            }

            disable(['姓名','总和', 'id'], true); // 通用禁用

            if (dept == '文案部') {
                disable(['工时(h)'], isAdopted == '是');
                disable(['最终推文中的字数'], isAdopted == '否');
            }

            if (dept == '编辑部') {
                disable(['工时(H)'], isAdopted == '是');
                disable(['是否原创'], isAdopted == '否');
                disable(['最终推文中的字数', '海报、壁纸、尾图数量', '是否广受好评1', '可视化设计、H5制作、手绘数量', '是否广受好评2', '根据反馈意见修改的工作时长(H)'], (isAdopted == '否' | isOriginal == '否'));
            }

            if (dept == '影视部') {
                disable(['拍摄时长(h)', '整理时长(h)'], (workType == '视频相关' | isAdopted == '否'));
                disable(['有哪些工作由记者团完成', '你负责了哪些工作', '视频时长(min)', '视频单价(￥/min,[60-120])'], (workType == '拍摄' | isAdopted == '否'));
                disable(['工时(h)'], isAdopted == '是');
                disable(['工作类型'], isAdopted == '否');
            }
            if (dept == '总计表格') {
                disable(['劳务费', '工作事项'], true);
            }
        }

        updateDisabled();
        Object.values(fields).forEach(f => f?.addEventListener('change', updateDisabled));
    });
}
// ======================= 多选弹窗逻辑 =======================
function setupMultiSelectModal() {
    document.getElementById("multiSelectConfirm").addEventListener("click", function () {
        const checked = Array.from(document.querySelectorAll("#multiSelectOptions input:checked")).map(c => c.value);
        currentMultiSelectInput.value = checked.join(",");
        console.log("更新后字段内容：", currentMultiSelectInput.name, currentMultiSelectInput.value);
        bootstrap.Modal.getInstance(document.getElementById('multiSelectModal')).hide();
    });
}

function openMultiSelect(inputElement) {
    currentMultiSelectInput = inputElement;
    const fieldName = inputElement.getAttribute("name");
    const options = multiSelectOptionsMap[fieldName] || [];
    const container = document.getElementById("multiSelectOptions");
    container.innerHTML = "";
    options.forEach(opt => {
        const id = "opt_" + opt;
        container.innerHTML += `<div><input type="checkbox" id="${id}" value="${opt}"><label for="${id}"> ${opt}</label></div>`;
    });

    const selected = inputElement.value.split(",").map(s => s.trim());
    selected.forEach(sel => {
        const checkbox = container.querySelector(`input[value="${sel}"]`);
        if (checkbox) checkbox.checked = true;
    });

    new bootstrap.Modal(document.getElementById('multiSelectModal')).show();
}

// ======================= 数据收集提交 =======================
function collectDataAndSubmit() {
    const rows = document.querySelectorAll("#dataTable tbody tr");
    const updates = [];

    rows.forEach(tr => {
        const row = {};
        tr.querySelectorAll("input, select").forEach(input => {
            const col = input.getAttribute("name");
            if (col && (!input.disabled || col === 'id')) {
                row[col] = input.value.trim();
            }
        });
        console.log("本行数据：", row);
        updates.push(row);
    });
    const invalidRow = updates.find(r =>
        r["是否采用"] === "是" &&
        r["工作类型"] === "视频相关" &&
        (r["有哪些工作由记者团完成"] === "" || r["你负责了哪些工作"] === "")
    );
    if (invalidRow) {
        alert("保存失败：多选不得为空值");
        return;                      // 这里才真正终止函数
    }
    fetch("/member/update_data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            department: document.querySelector('input[name="department"]').value,
            updates: updates
        })
    }).then(res => res.json()).then(data => {
        if (data.status === "success") {
            alert("保存成功！");
            document.getElementById("action").click();
        } else {
            wrong = "";
            if (data.message.includes("从字符串转换日期和/或时间时，转换失败")) {
                wrong = "日期格式不符合要求，正确示例：2025-07-02";
            }else if (data.message.includes("invalid literal for int()")) {
                wrong= "数字应为整数，正确示例：1";
            }else if (data.message.includes("check_price")) {
                wrong = "视频单价应为60-120之间的整数";
            }
            if (wrong) alert("保存失败：" + wrong);
            else alert("保存失败：" + data.message)
        }
    });
}

// ======================= 初始化入口 =======================
document.addEventListener("DOMContentLoaded",  ()=> {
    initDisableLogic();
    setupMultiSelectModal();
});
function deleteRow(btn) {
    if (confirm("确定要删除这行吗？")) {
        const row = btn.closest("tr");
        fetch("/member/delete_row", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                department: document.querySelector("input[name='department']").value,
                row_id: row.querySelector("input[name='id']").value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                row.remove(); // 成功时移除行
                alert("删除成功");
            } else {
                alert("删除失败: " + data.error);
            }
        })
    }
}
function settextModal() {
    return new Promise((resolve) => {
        const modal = new bootstrap.Modal(document.getElementById('textModal'));
        modal.show();

        // 确认按钮点击事件
        document.getElementById("textConfirm").addEventListener("click", function () {
            const number = document.getElementById("textModalInput").value;
            modal.hide();
            resolve(Number(number)); // 将值传递给Promise
        });

        // 取消按钮点击事件
        document.getElementById("textconcel").addEventListener("click", function () {
            modal.hide();
            resolve(false); // 用户取消，传递false
        });
    });
}
async function addRow() {
    var userInput = await settextModal();
    if (userInput) {
        fetch("/member/add_row", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                department: document.querySelector("select[name='department']").value,
                month: document.querySelector("select[name='month']").value,
                rows_num: userInput
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("action").click();
                    alert("添加成功");
                } else {
                    alert("添加失败: " + data.error);
                }
            })
    }
}
    </script>
</body>
</html>
